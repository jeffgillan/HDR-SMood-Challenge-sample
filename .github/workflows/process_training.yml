# ==============================================================================
# WORKFLOW METADATA
# ==============================================================================

name: Process Training Request

# ==============================================================================
# TRIGGERS - What events cause this workflow to run
# ==============================================================================

on:
  push:
    paths:
      - 'training_config.json'
  
  workflow_dispatch:
    inputs:
      test_mode:
        description: 'Test mode (skips actual training, just validates setup)'
        type: boolean
        default: false

# ==============================================================================
# JOBS
# ==============================================================================

jobs:
  train:
    runs-on: [self-hosted, HDR-runner-gpu]
    timeout-minutes: 1000
    
    #concurrency:
      #group: gpu-queue
      #cancel-in-progress: false

    env:
      USER_REPO: ${{ github.repository }}
      USER_BRANCH: ${{ github.ref_name }}
      USER_NAME: ${{ github.actor }}
      RUN_ID: ${{ github.run_id }}

    steps:
      # --------------------------------------------------------------------------
      # STEP 1: Print job information
      # --------------------------------------------------------------------------
      - name: Job Information
        run: |
          echo "================================================"
          echo "Training Request Details"
          echo "================================================"
          echo "User: ${USER_NAME}"
          echo "Repository: ${USER_REPO}"
          echo "Branch: ${USER_BRANCH}"
          echo "Run ID: ${RUN_ID}"
          echo "Triggered by: ${{ github.event_name }}"
          echo "Started: $(date)"
          echo "================================================"
      
      # --------------------------------------------------------------------------
      # STEP 2: Check GPU availability
      # --------------------------------------------------------------------------
      - name: Check GPU Availability
        run: |
          nvidia-smi
          echo "CUDA_VISIBLE_DEVICES=${CUDA_VISIBLE_DEVICES:-all}"
      
      # --------------------------------------------------------------------------
      # STEP 3: Checkout repository code
      # --------------------------------------------------------------------------
      - name: Checkout Repository Code
        uses: actions/checkout@v3
      
      # --------------------------------------------------------------------------
      # STEP 4: Load training configuration from JSON file
      # --------------------------------------------------------------------------
      - name: Load Training Configuration
        run: |
          echo "================================================"
          echo "Loading Training Configuration"
          echo "================================================"
          
          # Check if config file exists
          if [ ! -f training_config.json ]; then
            echo "ERROR: training_config.json not found!"
            exit 1
          fi
          
          # Install jq if needed
          if ! command -v jq &> /dev/null; then
            echo "Installing jq..."
            sudo apt-get update -qq
            sudo apt-get install -y jq
          fi
          
          # Display config
          echo "Configuration file contents:"
          cat training_config.json
          echo ""
          
          # Extract parameters
          SCRIPT_PATH=$(jq -r '.script_path // "train.py"' training_config.json)
          BATCH_SIZE=$(jq -r '.batch_size // 32' training_config.json)
          NUM_WORKERS=$(jq -r '.num_workers // 8' training_config.json)
          EPOCHS=$(jq -r '.epochs // 5' training_config.json)
          CYVERSE_OUTPUT_PATH=$(jq -r '.cyverse_output_path' training_config.json)

          # Validate CyVerse output path
          if [ "${CYVERSE_OUTPUT_PATH}" == "null" ] || [ -z "${CYVERSE_OUTPUT_PATH}" ]; then
            echo "ERROR: cyverse_output_path is required in training_config.json"
            exit 1
          fi
          
          # Derive output directory from script path
          # If script is "baselines/training/BioClip2/train.py"
          # Then OUTPUT_DIR becomes "baselines/training/BioClip2"
          SCRIPT_DIR=$(dirname ${SCRIPT_PATH})
          OUTPUT_DIR="${SCRIPT_DIR}"
          
          # Save as environment variables
          echo "SCRIPT_PATH=${SCRIPT_PATH}" >> $GITHUB_ENV
          echo "BATCH_SIZE=${BATCH_SIZE}" >> $GITHUB_ENV
          echo "NUM_WORKERS=${NUM_WORKERS}" >> $GITHUB_ENV
          echo "EPOCHS=${EPOCHS}" >> $GITHUB_ENV
          echo "OUTPUT_DIR=${OUTPUT_DIR}" >> $GITHUB_ENV
          echo "CYVERSE_OUTPUT_PATH=${CYVERSE_OUTPUT_PATH}" >> $GITHUB_ENV
          
          # Print loaded configuration
          echo "================================================"
          echo "Loaded Configuration:"
          echo "  Script: ${SCRIPT_PATH}"
          echo "  Batch Size: ${BATCH_SIZE}"
          echo "  Num Workers: ${NUM_WORKERS}"
          echo "  Epochs: ${EPOCHS}"
          echo "  Output Directory (derived): ${OUTPUT_DIR}"
          echo "  CyVerse Destination: ${CYVERSE_OUTPUT_PATH}"
          echo "================================================"
    
          # Generate single timestamp for this entire job
          TIMESTAMP=$(date +"%Y-%m-%d_%H-%M-%S")
          echo "TIMESTAMP=${TIMESTAMP}" >> $GITHUB_ENV
          echo "Job timestamp: ${TIMESTAMP}"
          
      # --------------------------------------------------------------------------
      # STEP 5: Test CyVerse access
      # --------------------------------------------------------------------------
      - name: Test CyVerse Access
        run: |
          # Test connection
          echo "Testing CyVerse connection..."
          gocmd ls ${CYVERSE_OUTPUT_PATH} > /dev/null 2>&1
          
          if [ $? -eq 0 ]; then
            echo "✓ CyVerse connection successful!"
          else
            echo "✗ CyVerse connection failed!"
            exit 1
          fi
      
      # STEP 6: Run training with uv
      # --------------------------------------------------------------------------
      - name: Run Training
        run: |
          echo "================================================"
          echo "Starting Training"
          echo "================================================"
          
          # Display training parameters
          echo "Training Parameters:"
          echo "  Script: ${SCRIPT_PATH}"
          echo "  Batch Size: ${BATCH_SIZE}"
          echo "  Num Workers: ${NUM_WORKERS}"
          echo "  Epochs: ${EPOCHS}"
          echo "  Output Directory: ${OUTPUT_DIR}"
          echo ""
          
          # Check if script exists
          if [ ! -f ${SCRIPT_PATH} ]; then
            echo "ERROR: ${SCRIPT_PATH} not found!"
            exit 1
          fi
          
          # Create a logs directory
          mkdir -p logs
          
          # Run training with uv
          # uv automatically handles:
          #   - Creating virtual environment
          #   - Installing dependencies from pyproject.toml
          #   - Running the script
          
          uv run python ${SCRIPT_PATH} \
            --batch_size ${BATCH_SIZE} \
            --num_workers ${NUM_WORKERS} \
            --epochs ${EPOCHS} \
            2>&1 | tee logs/training_${RUN_ID}.log
          
          # Check if training was successful
          if [ $? -eq 0 ]; then
            echo ""
            echo "================================================"
            echo "✓ Training Completed Successfully!"
            echo "================================================"
          else
            echo ""
            echo "================================================"
            echo "✗ Training Failed!"
            echo "================================================"
            exit 1
          fi

      # --------------------------------------------------------------------------
      # STEP 7: Create Training Summary File
      # --------------------------------------------------------------------------
      - name: Create Training Summary File
        if: always()
        run: |
          echo "Creating training summary file..."
    
          # Generate timestamp for the summary filename
          SUMMARY_FILE="training_summary_${TIMESTAMP}.txt"
    
          # Create summary file using echo statements (no heredoc)
          echo "======================================================" > ${SUMMARY_FILE}
          echo "TRAINING JOB SUMMARY" >> ${SUMMARY_FILE}
          echo "======================================================" >> ${SUMMARY_FILE}
          echo "Status: ${{ job.status }}" >> ${SUMMARY_FILE}
          echo "Run ID: ${RUN_ID}" >> ${SUMMARY_FILE}
          echo "User: ${USER_NAME}" >> ${SUMMARY_FILE}
          echo "Repository: ${USER_REPO}" >> ${SUMMARY_FILE}
          echo "Branch: ${USER_BRANCH}" >> ${SUMMARY_FILE}
          echo "" >> ${SUMMARY_FILE}
          echo "======================================================" >> ${SUMMARY_FILE}
          echo "TRAINING CONFIGURATION" >> ${SUMMARY_FILE}
          echo "======================================================" >> ${SUMMARY_FILE}
          echo "Script: ${SCRIPT_PATH}" >> ${SUMMARY_FILE}
          echo "Batch Size: ${BATCH_SIZE}" >> ${SUMMARY_FILE}
          echo "Num Workers: ${NUM_WORKERS}" >> ${SUMMARY_FILE}
          echo "Epochs: ${EPOCHS}" >> ${SUMMARY_FILE}
          echo "Output Directory: ${OUTPUT_DIR}" >> ${SUMMARY_FILE}
          echo "" >> ${SUMMARY_FILE}
          echo "======================================================" >> ${SUMMARY_FILE}
          echo "CYVERSE UPLOAD INFORMATION" >> ${SUMMARY_FILE}
          echo "======================================================" >> ${SUMMARY_FILE}
          echo "CyVerse Destination: ${CYVERSE_OUTPUT_PATH}" >> ${SUMMARY_FILE}
          echo "" >> ${SUMMARY_FILE}
          echo "======================================================" >> ${SUMMARY_FILE}
          echo "TIMING INFORMATION" >> ${SUMMARY_FILE}
          echo "======================================================" >> ${SUMMARY_FILE}
          echo "Job Timestamp: ${TIMESTAMP}" >> ${SUMMARY_FILE}
          echo "Completed: $(date)" >> ${SUMMARY_FILE}
          echo "" >> ${SUMMARY_FILE}
          echo "======================================================" >> ${SUMMARY_FILE}
          echo "GPU INFORMATION" >> ${SUMMARY_FILE}
          echo "======================================================" >> ${SUMMARY_FILE}
          nvidia-smi --query-gpu=name,memory.total,memory.used --format=csv,noheader >> ${SUMMARY_FILE}
          echo "" >> ${SUMMARY_FILE}
          echo "======================================================" >> ${SUMMARY_FILE}
          echo "NOTES" >> ${SUMMARY_FILE}
          echo "======================================================" >> ${SUMMARY_FILE}
          echo "This training job was executed on a self-hosted runner" >> ${SUMMARY_FILE}
          echo "with GPU acceleration. Results have been uploaded to" >> ${SUMMARY_FILE}
          echo "the specified CyVerse DataStore location." >> ${SUMMARY_FILE}
          echo "======================================================" >> ${SUMMARY_FILE}


          echo "✓ Summary file created: ${SUMMARY_FILE}"
    
          # Save filename for upload step
          echo "SUMMARY_FILE=${SUMMARY_FILE}" >> $GITHUB_ENV
    
          # Display the summary
          echo ""
          echo "Summary file contents:"
          cat ${SUMMARY_FILE}

    
      # --------------------------------------------------------------------------
      # STEP 8: Upload results to CyVerse
      # --------------------------------------------------------------------------
      - name: Upload Results to CyVerse
        if: always()
        run: |
          echo "================================================"
          echo "Uploading Results to CyVerse"
          echo "================================================"

          # Generate timestamp for unique filename
          MODEL_NAME="model"
          TIMESTAMPED_MODEL="${MODEL_NAME}_${TIMESTAMP}.pth"

          # Save to environment for later steps
          echo "TIMESTAMPED_MODEL=${TIMESTAMPED_MODEL}" >> $GITHUB_ENV

          # Use the user-specified CyVerse destination path
          CYVERSE_DEST="${CYVERSE_OUTPUT_PATH}"

          echo "Source (local): ${OUTPUT_DIR}/model.pth"
          echo "Destination (CyVerse): ${CYVERSE_DEST}/${TIMESTAMPED_MODEL}"
          echo ""

          # Upload model with timestamped filename
          if [ -d ${OUTPUT_DIR} ]; then
            echo "Uploading outputs from ${OUTPUT_DIR}..."

            if [ -f ${OUTPUT_DIR}/model.pth ]; then
              echo "Found model.pth, uploading as ${TIMESTAMPED_MODEL}..."

              # Upload without -f flag (no overwrite needed with unique names)
              gocmd put ${OUTPUT_DIR}/model.pth ${CYVERSE_DEST}/${TIMESTAMPED_MODEL}

              if [ $? -eq 0 ]; then
                echo "✓ Model uploaded successfully as ${TIMESTAMPED_MODEL}!"
              else
                echo "✗ Model upload failed!"
                # Don't exit - allow workflow to continue
              fi
            else
              echo "Warning: model.pth not found in ${OUTPUT_DIR}"
            fi
          else
            echo "Warning: Output directory ${OUTPUT_DIR} not found"
          fi

          # Upload training summary file
          if [ -f ${SUMMARY_FILE} ]; then
            echo ""
            echo "Uploading training summary file..."
            gocmd put ${SUMMARY_FILE} ${CYVERSE_DEST}/${SUMMARY_FILE}
      
            if [ $? -eq 0 ]; then
              echo "✓ Summary file uploaded successfully as ${SUMMARY_FILE}!"
            else
              echo "✗ Summary file upload failed!"
            fi
          else
            echo "Warning: Summary file not found"
          fi

          echo "✓ Upload complete!"

          # List uploaded files
          echo ""
          echo "Files in ${CYVERSE_DEST}:"
          gocmd ls ${CYVERSE_DEST}

          echo ""
          echo "================================================"
          echo "✓ Results Upload Complete!"
          echo "================================================"
          echo "Model Location:"
          echo "${CYVERSE_DEST}/${TIMESTAMPED_MODEL}"
          echo ""
          echo "Summary Location:"
          echo "${CYVERSE_DEST}/${SUMMARY_FILE}"
          echo ""
          echo "To download in CyVerse JupyterLab:"
          echo "gocmd get ${CYVERSE_DEST}/${TIMESTAMPED_MODEL} ./model.pth"
          echo "gocmd get ${CYVERSE_DEST}/${SUMMARY_FILE} ./summary.txt"
          echo "================================================"
          
      
      # --------------------------------------------------------------------------
      # STEP 9: Cleanup
      # --------------------------------------------------------------------------
      - name: Cleanup
        if: always()
        run: |
          echo "================================================"
          echo "Cleaning Up Runner Workspace"
          echo "================================================"

          # Remove CyVerse credentials (security)
          echo "Removing CyVerse credentials..."
          rm -f ~/.irods/gocmd.yaml

          # Remove HuggingFace cache (can be very large)
          if [ -d ~/.cache/huggingface ]; then
            echo "Removing HuggingFace cache..."
            du -sh ~/.cache/huggingface
            rm -rf ~/.cache/huggingface
            echo "✓ HuggingFace cache removed"
          fi

          # GitHub Actions automatically cleans up the workspace, but for
          # self-hosted runners, we can explicitly clean up if needed
          # Note: This runs in the repo directory, so we need to go up first
          echo "Current directory: $(pwd)"

          # Optional: Remove the checked out repository clone
          # Uncomment if you want explicit cleanup (normally Actions handles this)
          # cd ..
          # rm -rf HDR-SMood-Challenge-sample

          echo "✓ Cleanup complete!"
      
      # --------------------------------------------------------------------------
      # STEP 10: Final summary
      # --------------------------------------------------------------------------
      - name: Training Summary
        if: always()
        run: |
          echo ""
          echo "========================================================"
          echo "TRAINING JOB SUMMARY"
          echo "========================================================"
          echo "Status: ${{ job.status }}"
          echo "Run ID: ${RUN_ID}"
          echo "User: ${USER_NAME}"
          echo "Script: ${SCRIPT_PATH}"
          echo "Batch Size: ${BATCH_SIZE}"
          echo "Num Workers: ${NUM_WORKERS}"
          echo "Epochs: ${EPOCHS}"
          echo "Model uploaded to CyVerse:"
          echo "${CYVERSE_OUTPUT_PATH}/${TIMESTAMPED_MODEL}"
          echo ""
          echo "Completed: $(date)"
          echo "========================================================"
